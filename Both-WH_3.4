// ==UserScript==
// @name        Both-WH â­
// @namespace        http://tampermonkey.net/
// @version        3.4
// @description        ã€Œé€šå¸¸è¡¨ç¤ºã€ã€ŒHTMLè¡¨ç¤ºã€ã®ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’ã€ŒCtrl+F8ã€ã§å¾€å¾©ã™ã‚‹
// @author        Ameba Blog User
// @match        https://blog.ameba.jp/ucs/entry/srventry*
// @exclude        https://blog.ameba.jp/ucs/entry/srventrylist.do*
// @icon        https://www.google.com/s2/favicons?sz=64&domain=ameblo.jp
// @grant        none
// ==/UserScript==


let retry=0;
let interval=setInterval(wait_target, 100);
function wait_target(){
    retry++;
    if(retry>10){ // ãƒªãƒˆãƒ©ã‚¤åˆ¶é™ 10å› 1sec
        clearInterval(interval); }
    let target=document.getElementById('cke_1_contents'); // ç›£è¦– target
    if(target){
        clearInterval(interval);
        main(); }}


function main(){
    let editor_iframe;
    let iframe_doc;
    let wysiwyg; // é€šå¸¸è¡¨ç¤ºã® iframeå†… html
    let native_line; // é€šå¸¸è¡¨ç¤ºã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®
    let selection;
    let range;
    let insert_node;
    let mark_regex;
    let activeline;
    let codemirror_scroll;


    let target=document.getElementById('cke_1_contents'); // ç›£è¦– target ã¯3ç®‡æ‰€ã§å…±ç”¨
    let monitor1=new MutationObserver( catch_key );
    monitor1.observe(target, {childList: true}); // ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆå¾…å—ã‘é–‹å§‹

    catch_key();

    function catch_key(){
        if(document.querySelector('.cke_wysiwyg_frame') !=null){ //ã€Œé€šå¸¸è¡¨ç¤ºã€ã‹ã‚‰å®Ÿè¡Œé–‹å§‹
            editor_iframe=document.querySelector('.cke_wysiwyg_frame');
            iframe_doc=editor_iframe.contentWindow.document;

            if(iframe_doc.querySelector('#i')){
                iframe_doc.querySelector('#i').remove(); } // å®‰å…¨ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã«é€šå¸¸è¡¨ç¤ºã«æˆ»ã‚Šè‡ªå‹•å‰Šé™¤ğŸ”´

            iframe_doc.addEventListener('keydown', check_key);
            function check_key(event){
                if(event.which==17 || event.ctrlKey==true){
                    if(event.which==119 || event.keyCode==119){ set_mark(); }}}


            function set_mark(){
                selection=iframe_doc.getSelection();
                range=selection.getRangeAt(0);
                insert_node=iframe_doc.createElement("i"); // iã‚¿ã‚° ç©ºã‚¿ã‚°
                insert_node.appendChild(iframe_doc.createTextNode("\u200B"));
                insert_node.setAttribute("id", "i");
                range.insertNode(insert_node); // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã«ãƒãƒ¼ã‚¯ã‚¿ã‚°ã‚’æ›¸ãè¾¼ã‚€

                wysiwyg=iframe_doc.querySelector('html');
                native_line=wysiwyg.scrollTop; // é€šå¸¸è¡¨ç¤ºã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’è¨˜éŒ²

                let html_button=document.querySelector('button[data-mode="source"]');
                html_button.click( in_CodeMirror() ); // HTMLè¡¨ç¤ºã«ç§»å‹• ğŸŸ¦

                function in_CodeMirror(){
                    let monitor2=new MutationObserver( task_CodeMirror );
                    monitor2.observe(target, {childList: true});

                    function task_CodeMirror(){
                        if(document.querySelector('.CodeMirror-activeline pre')){ // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è¡ŒãŒæ¡ä»¶
                            function key_in(key_Code){
                                let keyEvent=new KeyboardEvent('keydown', {keyCode: key_Code});
                                document.querySelector('.CodeMirror textarea').dispatchEvent(keyEvent); }
                            mark_regex=RegExp('<i id="i">â€¢</i>');

                            for(let j=0; j<120; j++){
                                let code=document.querySelector('.CodeMirror-code');
                                if(mark_regex.test(code.textContent)==true ){ break; }
                                else{ key_in(34); }} // PageDownã§æ¤œç´¢ã‚¨ãƒªã‚¢ã‚’æ¢ã™

                            let line_count=0;
                            for(let j=0; j<3000; j++){
                                activeline=document.querySelector('.CodeMirror-activeline pre');
                                if(mark_regex.test(activeline.textContent)==true ){ break; }
                                else{ line_count +=1; key_in(40); }} // Down ã§ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è¡Œã‚’ä¸‹æ–¹ã¸ç§»å‹•

                            let index_uni=activeline.textContent.indexOf('<i id="i">â€¢</i>'); // unicode16ã®æ–‡å­—æ•°
                            let real=activeline.textContent.match(/./ug); // ã‚µãƒ­ã‚²ãƒ¼ãƒˆãƒšã‚¢ã‚’1æ–‡å­—ã«æ–‡å­—åˆ—ã‚’é…åˆ—åŒ–
                            // console.log('realï¼šã€€' + real); // é…åˆ—ãƒã‚§ãƒƒã‚¯ç”¨ã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚³ãƒ¼ãƒ‰ ğŸ”´

                            let sur=0; // ã‚µãƒ­ã‚²ãƒ¼ãƒˆãƒšã‚¢æ–‡å­—è£œæ­£å€¤
                            for(let k=0; k<index_uni; k++){
                                let str=real.slice(index_uni - k, index_uni - k +15).join('');
                                if(str=='<i id="i">â€¢</i>'){ sur=k; break; }}
                            index_uni -=sur; // ã‚µãƒ­ã‚²ãƒ¼ãƒˆãƒšã‚¢æ–‡å­—ã®ã‚ºãƒ¬è£œæ­£ã—ãŸindex

                            let vas=0; // ç•°ä½“å­—ã®çµåˆæ–‡å­—è£œæ­£å€¤
                            for(let k=0; k<index_uni; k++){
                                if(real[k]=='â€¢'){ vas +=1; } // çµ„æ–‡å­—ã«ä½¿ç”¨ã•ã‚Œã‚‹ã‚¼ãƒ­å¹…æ¥åˆå­
                                if(real[k]=='\uFE0F'){
                                    if(real[k+1]=='\u20E3'){ vas +=2; } // ç‰¹æ®Šãªâ–¢æ•°å­—ã®ç•°ä½“å­—ã®å ´åˆ
                                    else{ vas +=1; }} // ç•°ä½“å­—ã«ä½¿ç”¨ã•ã‚Œã‚‹çµåˆæ–‡å­—
                                if(real[k]=='\uFE0E'){ vas +=1; }} // ç•°ä½“å­—ã«ä½¿ç”¨ã•ã‚Œã‚‹çµåˆæ–‡å­—
                            index_uni -=vas; // ç•°ä½“å­—çµåˆæ–‡å­—ã®ã‚ºãƒ¬è£œæ­£ã—ãŸindex

                            let spa=0; // è¡Œé ­ã®åŠè§’ç©ºç™½ã«ã‚ˆã‚‹indexè£œæ­£å€¤ï¼ˆTabæ–‡å­—è£œæ­£ã‚’å«ã‚€ï¼‰
                            for(let k=0; k<index_uni; k++){
                                if(activeline.textContent.indexOf('\u0020', k)==k ||
                                   activeline.textContent.indexOf('\u00A0', k)==k){
                                    spa+=1; }
                                else break; }
                            index_uni -=spa; // è¡Œé ­ã®åŠè§’ç©ºç™½ã«ã‚ˆã‚‹ã‚ºãƒ¬è£œæ­£ã‚’ã—ãŸindex

                            key_in(36); // brã®æ”¹è¡Œã§è¡Œé ­ã®çµµæ–‡å­—ã®å¾Œã«ã‚«ãƒ¼ã‚½ãƒ«ãŒå…¥ã‚‹å ´åˆã‚’ä¿®æ­£ã™ã‚‹
                            for(let i=0; i<index_uni; i++){ key_in(39); } // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è¡Œå†…ã§å³æ–¹ã¸indexå€¤ã ã‘ç§»å‹•
                            let zero_stop=0; //ã€ŒHTMLè¡¨ç¤ºã€ã§ãƒãƒ¼ã‚¯ã‚¿ã‚°å‰Šé™¤ã‚’ã—ãªã„å®‰å…¨ãƒ¢ãƒ¼ãƒ‰ã¯ã€Œ1ã€ã«å¤‰æ›´ ğŸ”´
                            if(zero_stop==1){ key_in(37); } // å·¦ã¸1æ–‡å­—ç§»å‹•ã™ã‚‹ã ã‘ã§ ãƒãƒ¼ã‚¯ã‚¿ã‚°ã‚’å‰Šé™¤ã—ãªã„
                            else{
                                for(let i=0; i<15; i++){ key_in(46); }} // ãƒãƒ¼ã‚¯ã‚¿ã‚°æ–‡å­—åˆ—ã®15æ–‡å­—ã‚’å‰Šé™¤

                            codemirror_scroll=document.querySelector('.CodeMirror-scroll');
                            let win_height=codemirror_scroll.clientHeight;
                            let styles=getComputedStyle(document.querySelector('.cm-bracket'));
                            let line_height=parseFloat(styles.lineHeight);
                            let scroll=0;
                            if(line_count*line_height>=0.4*win_height){
                                if(line_count*line_height>=win_height){ scroll=0.6*win_height; }
                                else{ scroll=line_count*line_height - 0.4*win_height; }}
                            codemirror_scroll.scrollTop +=scroll;

                            document.querySelector('.CodeMirror textarea').focus(); // å…¥åŠ›çª“ã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’å…¥ã‚Œã‚‹
                            monitor2.disconnect(); } // task_CodeMirrorã®çµ‚äº†ã§ç›£è¦–ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
                    }} // in_CodeMirror
            } // set_mark
        } // WYSIWYGè¡¨ç¤ºã§ã®å ´åˆ


        else if(document.querySelector('.CodeMirror') !=null){ //ã€ŒHTMLè¡¨ç¤ºã€ã‹ã‚‰å®Ÿè¡Œé–‹å§‹
            document.querySelector('.CodeMirror').addEventListener('keydown', function(event){
                if(event.which==17 || event.ctrlKey==true){
                    if(event.which==119 || event.keyCode==119){ to_native_line(); }}});


            function to_native_line(){
                let wysiwyg_button=document.querySelector('button[data-mode="wysiwyg"]');
                wysiwyg_button.click( in_wysiwyg() ); // é€šå¸¸è¡¨ç¤ºã«ç§»å‹• ğŸŸ¦

                function in_wysiwyg(){
                    let monitor3=new MutationObserver( task_wysiwyg );
                    monitor3.observe(target, {childList: true});

                    task_wysiwyg();

                    function task_wysiwyg(){
                        if(document.querySelector('.cke_wysiwyg_frame') !=null){ //ã€Œé€šå¸¸è¡¨ç¤ºã€ãŒæ¡ä»¶
                            editor_iframe=document.querySelector('.cke_wysiwyg_frame');
                            iframe_doc=editor_iframe.contentWindow.document;
                            wysiwyg=iframe_doc.querySelector('html');

                            wysiwyg.scrollTop=native_line; // è¨˜éŒ²ã•ã‚ŒãŸé€šå¸¸è¡¨ç¤ºã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã«ç§»å‹•
                            if(wysiwyg.scrollTop==native_line){
                                monitor3.disconnect(); }}} // task_wysiwyg ã®çµ‚äº†ã§ç›£è¦–ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
                } // in_wysiwyg
            } // to_native_line
        } // HTMLè¡¨ç¤ºã§ã®å ´åˆ
    } // catch_key

}
